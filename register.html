<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8">
  <title>Daftar Akun | Web Perusahaan</title>
  <link rel="stylesheet" href="style.css">
  <style>
    .page-login * { box-sizing: border-box; font-family: "Segoe UI", Arial, sans-serif; }
    body.page-login {
      margin: 0;
      background: linear-gradient(135deg, #1e3c72, #2a5298);
      min-height: 100vh;
      display: flex;
      justify-content: center;
      align-items: center;
      color: #333;
    }
    .page-login .card {
      background: #ffffff;
      width: 100%;
      max-width: 400px;
      padding: 30px;
      border-radius: 14px;
      box-shadow: 0 20px 40px rgba(0,0,0,0.2);
      text-align: center;
    }
    .page-login .card h2 { margin-bottom: 20px; color: #1e3c72; }
    .input-group { position: relative; margin-bottom: 14px; }
    .page-login input {
      width: 100%;
      padding: 12px 14px;
      border-radius: 8px;
      border: 1px solid #ccc;
      font-size: 15px;
    }
    .page-login input:focus {
      outline: none;
      border-color: #2a5298;
      box-shadow: 0 0 0 2px rgba(42,82,152,0.2);
    }
    .check {
      display: inline-block;
      width: 12px;
      height: 12px;
      border-radius: 50%;
      position: absolute;
      right: 10px;
      top: 50%;
      transform: translateY(-50%);
    }
    .green { background-color: green; }
    .red { background-color: red; }
    .page-login button {
      width: 100%;
      padding: 12px;
      background: #1e3c72;
      color: white;
      border: none;
      border-radius: 8px;
      font-size: 16px;
      font-weight: bold;
      cursor: pointer;
      transition: 0.3s;
    }
    .page-login button:hover { background: #2a5298; }
    #msg { margin-top: 10px; font-size: 14px; color: red; }
    @media (max-width: 480px) {
      body.page-login .card { margin: 20px; padding: 24px; }
    }
  </style>
</head>
<body class="page-login auth">

  <div class="card">
    <h2>Daftar Akun</h2>

    <div class="input-group">
      <input id="nama" placeholder="Nama">
      <span id="namaCheck" class="check"></span>
    </div>
    <div class="input-group">
      <input id="email" placeholder="Email">
      <span id="emailCheck" class="check"></span>
    </div>
    <div class="input-group">
      <input id="telp" placeholder="Nomor Telepon">
      <span id="telpCheck" class="check"></span>
    </div>
    <div class="input-group">
      <input id="alamat" placeholder="Alamat">
      <span id="alamatCheck" class="check"></span>
    </div>
    <div class="input-group">
      <input id="password" type="password" placeholder="Password">
      <span id="passwordCheck" class="check"></span>
    </div>
    <div class="input-group">
      <input id="confirm" type="password" placeholder="Konfirmasi Password">
      <span id="confirmCheck" class="check"></span>
    </div>

    <button id="registerBtn">Simpan</button>
    <p id="msg"></p>
  </div>

  <script src="firebase.js"></script>
  <script src="auth.js"></script>
  <script>
    const namaInput = document.getElementById("nama");
    const emailInput = document.getElementById("email");
    const telpInput = document.getElementById("telp");
    const alamatInput = document.getElementById("alamat");
    const passwordInput = document.getElementById("password");
    const confirmInput = document.getElementById("confirm");
    const msg = document.getElementById("msg");
    const registerBtn = document.getElementById("registerBtn");

    function setCheck(element, condition){ element.className = condition ? "check green" : "check red"; }

    // VALIDASI REAL-TIME
    namaInput.addEventListener("input", ()=>setCheck(document.getElementById("namaCheck"), namaInput.value.length > 0 && namaInput.value.length <= 15));

    emailInput.addEventListener("input", async ()=>{
      const email = emailInput.value.trim();
      const validFormat = /^[\w.+-]+@gmail\.com$/.test(email);
      let notTaken = true;
      if(validFormat){
        try{
          const methods = await firebase.auth().fetchSignInMethodsForEmail(email);
          if(methods.length > 0) notTaken = false;
        } catch(e){ notTaken = false; }
      }
      setCheck(document.getElementById("emailCheck"), validFormat && notTaken);
    });

    telpInput.addEventListener("input", ()=>setCheck(document.getElementById("telpCheck"), telpInput.value.trim() !== ""));
    alamatInput.addEventListener("input", ()=>setCheck(document.getElementById("alamatCheck"), alamatInput.value.trim() !== ""));
    passwordInput.addEventListener("input", ()=>{
      const pass = passwordInput.value;
      const valid = /^(?=.*[A-Z])(?=.*[a-z])(?=.*[0-9!@#$%^&*]).{8,}$/.test(pass) && /^[A-Z]/.test(pass);
      setCheck(document.getElementById("passwordCheck"), valid);
      setCheck(document.getElementById("confirmCheck"), confirmInput.value === pass && confirmInput.value !== "");
    });
    confirmInput.addEventListener("input", ()=>setCheck(document.getElementById("confirmCheck"), confirmInput.value === passwordInput.value && confirmInput.value !== ""));

    // REGISTER
    registerBtn.addEventListener("click", async ()=>{
      msg.textContent = "";
      msg.style.color = "red";

      if(document.querySelectorAll(".check.green").length !== 6){
        msg.textContent = "Periksa semua field, pastikan benar!";
        return;
      }

      const nama = namaInput.value.trim();
      const email = emailInput.value.trim();
      const telp = telpInput.value.trim();
      const alamat = alamatInput.value.trim();
      const password = passwordInput.value;

      try{
        const methods = await firebase.auth().fetchSignInMethodsForEmail(email);
        if(methods.length > 0){
          msg.textContent = "Email sudah terdaftar!";
          return;
        }

        const userCredential = await firebase.auth().createUserWithEmailAndPassword(email, password);
        const user = userCredential.user;

        await firebase.firestore().collection("users").doc(user.uid).set({
          nama, email, telp, alamat,
          createdAt: firebase.firestore.FieldValue.serverTimestamp()
        });

        await user.sendEmailVerification();

        msg.style.color = "green";
        msg.textContent = "Akun berhasil dibuat! Silahkan cek email untuk verifikasi.";
        setTimeout(()=> window.location.href="login.html", 3000);

      } catch(err){
        msg.textContent = "Gagal mendaftar: " + err.message;
      }
    });
  </script>

</body>
</html>
