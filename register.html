<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<title>Daftar Akun | Web Perusahaan</title>
<style>
/* ---------------------- Loader ---------------------- */
.btn-loader {
  display: inline-block;
  width: 20px;
  height: 20px;
  border: 3px solid #f3f3f3;
  border-top: 3px solid #fff;
  border-radius: 50%;
  animation: spin 1s linear infinite;
  vertical-align: middle;
  margin-left: 10px;
}
.loader {
  display: none;
  border: 4px solid #f3f3f3;
  border-top: 4px solid #1e3c72;
  border-radius: 50%;
  width: 24px;
  height: 24px;
  animation: spin 1s linear infinite;
  margin: 10px auto;
}
@keyframes spin {
  0% { transform: rotate(0deg); }
  100% { transform: rotate(360deg); }
}

/* ---------------------- Global ---------------------- */
* { box-sizing: border-box; font-family: "Segoe UI", Arial, sans-serif; }
body.page-login.auth {
  margin: 0;
  background: linear-gradient(135deg, #1e3c72, #2a5298);
  min-height: 100vh;
  display: flex;
  justify-content: center;
  align-items: center;
  color: #333;
}

/* ---------------------- Card ---------------------- */
.card {
  background: #ffffff;
  width: 90%;
  max-width: 480px;
  padding: 30px 25px;
  border-radius: 14px;
  box-shadow: 0 20px 40px rgba(0,0,0,0.2);
  text-align: center;
  margin-top: 40px;
}
.card h2 { margin-bottom: 20px; color: #1e3c72; }

/* ---------------------- Input ---------------------- */
.input-group { position: relative; margin-bottom: 14px; text-align: left; }
input {
  width: 100%;
  padding: 12px 14px;
  border-radius: 8px;
  border: 1px solid #ccc;
  font-size: 15px;
}
input:focus {
  outline: none;
  border-color: #2a5298;
  box-shadow: 0 0 0 2px rgba(42,82,152,0.2);
}
.check {
  display: inline-block;
  width: 12px;
  height: 12px;
  border-radius: 50%;
  position: absolute;
  right: 10px;
  top: 50%;
  transform: translateY(-50%);
}
.green { background-color: green; }
.red { background-color: red; }
.note { font-size: 12px; color: #555; margin: 4px 0; }

/* ---------------------- Show Password ---------------------- */
.show-pass {
  text-align: center;
  margin-bottom: 14px;
}
.show-pass input {
  margin-bottom: 4px;
}

/* ---------------------- Button ---------------------- */
button {
  width: 100%;
  padding: 12px;
  background: #1e3c72;
  color: white;
  border: none;
  border-radius: 8px;
  font-size: 16px;
  font-weight: bold;
  cursor: pointer;
  transition: 0.3s;
  position: relative;
}
button:disabled { background: #888; cursor: not-allowed; }
button:hover:not(:disabled) { background: #2a5298; }

#msg { margin-top: 10px; font-size: 14px; text-align: center; }

/* ---------------------- Responsive ---------------------- */
@media (max-width: 480px) { 
  .card { margin: 20px; padding: 24px; } 
}
</style>
</head>

<body class="page-login auth">

<div class="card">
  <h2>Daftar Akun</h2>

  <!-- Nama -->
  <div class="input-group">
    <input id="nama" placeholder="Nama">
    <span id="namaCheck" class="check"></span>
  </div>

  <!-- Nomor Telepon -->
  <div class="input-group">
    <input id="telp" placeholder="Nomor Telepon">
    <span id="telpCheck" class="check"></span>
  </div>

  <!-- Alamat -->
  <div class="input-group">
    <input id="alamat" placeholder="Alamat">
    <span id="alamatCheck" class="check"></span>
  </div>

  <!-- Email -->
  <div class="input-group">
    <input id="email" placeholder="Email">
    <span id="emailCheck" class="check"></span>
    <div class="note">Gunakan Gmail valid</div>
  </div>

  <!-- Password -->
  <div class="input-group">
    <input id="password" type="password" placeholder="Password">
    <span id="passwordCheck" class="check"></span>
  </div>

  <!-- Konfirmasi Password -->
  <div class="input-group">
    <input id="confirm" type="password" placeholder="Konfirmasi Password">
    <span id="confirmCheck" class="check"></span>
    <div class="note">Minimal 8 karakter, huruf besar di awal, angka/karakter khusus</div>
  </div>

  <!-- Show Password -->
  <div class="show-pass">
    <input type="checkbox" id="showPass">
    <div><label for="showPass">Show Password</label></div>
  </div>

  <!-- Loader -->
  <div class="loader" id="loader"></div>

  <!-- Tombol Simpan -->
  <button id="registerBtn" disabled>
    Simpan
    <span id="btnLoader" class="btn-loader" style="display:none;"></span>
  </button>

  <!-- Pesan -->
  <p id="msg"></p>
</div>

<script src="firebase.js"></script>
<script src="auth.js"></script>
<script>
const namaInput = document.getElementById("nama");
const emailInput = document.getElementById("email");
const telpInput = document.getElementById("telp");
const alamatInput = document.getElementById("alamat");
const passwordInput = document.getElementById("password");
const confirmInput = document.getElementById("confirm");
const msg = document.getElementById("msg");
const registerBtn = document.getElementById("registerBtn");
const loader = document.getElementById("loader");
const btnLoader = document.getElementById("btnLoader");
const showPass = document.getElementById("showPass");
let emailValid = false;

// Toggle Show Password
showPass.addEventListener("change", () => {
  const type = showPass.checked ? "text" : "password";
  passwordInput.type = type;
  confirmInput.type = type;
});

// Set check mark
function setCheck(element, condition) {
  element.className = condition ? "check green" : "check red";
}

// Enable button if all fields valid
function enableButton() {
  const allValid =
    namaInput.value.trim().length > 0 && namaInput.value.trim().length <= 15 &&
    emailValid &&
    telpInput.value.trim() !== "" &&
    alamatInput.value.trim() !== "" &&
    /^(?=.*[A-Z])(?=.*[a-z])(?=.*[0-9!@#$%^&*]).{8,}$/.test(passwordInput.value) &&
    /^[A-Z]/.test(passwordInput.value) &&
    confirmInput.value === passwordInput.value && confirmInput.value !== "";
  registerBtn.disabled = !allValid;
}

// Input listeners
namaInput.addEventListener("input", () => { 
  setCheck(document.getElementById("namaCheck"), namaInput.value.length > 0 && namaInput.value.length <= 15); 
  enableButton(); 
});
telpInput.addEventListener("input", () => { 
  setCheck(document.getElementById("telpCheck"), telpInput.value.trim() !== ""); 
  enableButton(); 
});
alamatInput.addEventListener("input", () => { 
  setCheck(document.getElementById("alamatCheck"), alamatInput.value.trim() !== ""); 
  enableButton(); 
});
passwordInput.addEventListener("input", () => {
  const pass = passwordInput.value;
  const valid = /^(?=.*[A-Z])(?=.*[a-z])(?=.*[0-9!@#$%^&*]).{8,}$/.test(pass) && /^[A-Z]/.test(pass);
  setCheck(document.getElementById("passwordCheck"), valid);
  setCheck(document.getElementById("confirmCheck"), confirmInput.value === pass && confirmInput.value !== "");
  enableButton();
});
confirmInput.addEventListener("input", () => { 
  setCheck(document.getElementById("confirmCheck"), confirmInput.value === passwordInput.value && confirmInput.value !== ""); 
  enableButton(); 
});

// Validate email
async function validateEmail() {
  loader.style.display = "block";
  const email = emailInput.value.trim();
  const validFormat = /^[\w.+-]+@gmail\.com$/.test(email);
  let notTaken = false;
  if (validFormat) {
    try {
      const methods = await firebase.auth().fetchSignInMethodsForEmail(email);
      notTaken = methods.length === 0;
    } catch (e) { notTaken = false; }
  }
  emailValid = validFormat && notTaken;
  setCheck(document.getElementById("emailCheck"), emailValid);
  enableButton();
  loader.style.display = "none";
}
emailInput.addEventListener("input", validateEmail);

// Register user
registerBtn.addEventListener("click", async () => {
  msg.textContent = "";
  msg.style.color = "red";
  registerBtn.disabled = true;
  loader.style.display = "block";
  btnLoader.style.display = "inline-block";

  const nama = namaInput.value.trim();
  const email = emailInput.value.trim();
  const telp = telpInput.value.trim();
  const alamat = alamatInput.value.trim();
  const password = passwordInput.value;

  try {
    const methods = await firebase.auth().fetchSignInMethodsForEmail(email);
    if (methods.length > 0){ 
      msg.textContent = "Email sudah terdaftar!";
      return; // tetap ke finally
    }

    const userCredential = await firebase.auth().createUserWithEmailAndPassword(email, password);
    const user = userCredential.user;

    await firebase.firestore().collection("users").doc(user.uid).set({
      nama, email, telp, alamat,
      createdAt: firebase.firestore.FieldValue.serverTimestamp()
    });

    await user.sendEmailVerification();
    msg.style.color = "green";
    msg.textContent = "Akun berhasil dibuat! Silahkan cek email untuk verifikasi.";
    setTimeout(() => window.location.href = "login.html", 3000);

  } catch (err) {
    msg.textContent = "Gagal mendaftar: " + err.message;
  } finally {
    loader.style.display = "none";
    btnLoader.style.display = "none";
    registerBtn.disabled = false;
  }
});
</script>

</body>
</html>
